<!DOCTYPE html>
<html>
<head>
    <title>INFO 3300 - Data-driven Web Applications</title>
    <link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet">
    <script src="https://d3js.org/d3.v4.min.js"></script>
   <style>
        svg {border: solid black 1px}
    </style>
</head>

<body>
    <svg width="1600" height="1000" id="svg"></svg>
    <svg width="600" height="500" id="svg2"></svg>
</body>

<div id="popculture"> </div>
<script id="Male Bible Names">
    var colors = ["rgb(101,82,114)", "rgb(69,73,95)", "rgb(72,102,88)", "rgb(73,90,108)", "rgb(83,98,99)", "rgb(83,107,89)", "rgb(109,43,61)", "rgb(60,54,80)", "rgb(46,80,46)"]

    var svg = d3.select("#svg");
    var width = svg.attr("width");
    var height = svg.attr("height")-100;

    var svg2 = d3.select("#svg2");
    var width2 = svg2.attr("width");
    var height2 = svg2.attr("height");

    var bibNames = ["Jacob", "Michael", "Matthew", "Andrew",
                    "James", "Joshua", "David", "Christopher", "John"];

    var scaleX = d3.scaleLinear()
                .domain([1910,2015])
                .range([100, width-30]);

    var bottom = d3.axisBottom(scaleX)
                .tickValues(d3.range(1910,2015,5))
                .tickFormat(d3.format("d"));

    var scaleY = d3.scaleBand()
                .domain(bibNames)
                .range([height-55, 45]);

    var left = d3.axisLeft(scaleY);

    var scaleRad = d3.scaleSqrt()
                .domain([0,0.06])
                .range([0, 58]);

    svg.append("g")
        .attr("id", "lft")
        .call(left)
        .attr("transform", "translate(100, 0)");

    svg.append("g")
        .attr("id", "btm")
        .call(bottom)
        .attr("transform", "translate(0, 845)");


    var pwidth = 1000;
	var pheight = 800;
	var padding = 40;

	var xScale = d3.scaleLinear().domain([1913, 2015]).range([padding * 2, pwidth - padding ]);
	var yScale = d3.scaleLinear().domain([0, 0.07]).range([pheight - (padding *2),padding]);

	var psvg = d3.select("#popculture").append("svg")
	    .attr("width", pwidth)
	    .attr("height", pheight);

	var xAxis = d3.axisBottom(xScale).ticks(12).tickFormat(d3.format("d"));
	var yAxis = d3.axisLeft(yScale).ticks(20);

	psvg.append("g")
		.attr("transform", "translate(0," + (pheight - padding - padding) + ")")
		.call(xAxis)
		.selectAll("text").attr("transform","rotate(90) translate(6,-13)").style("text-anchor","start");

	psvg.append("g")
	    .call(yAxis)
	 	.attr("transform", "translate(" + (padding + padding) + ",0)");


	var popculturenames = ["Mariah", "Emma", "Jennifer", "Rachel", "Linda"];
	//var popculturenames = ["Mariah", "Jennifer"];
	var namecolors = {"Mariah":"rgb(101,82,134)", "Emma":"rgb(173,173,92)", "Jennifer":"rgb(77,153,153)", "Rachel":"rgb(102,153,0)", "Linda":"rgb(123,18,99)"};

    var colors = ["rgb(101,82,114)", "rgb(69,73,95)", "rgb(72,102,88)", "rgb(73,90,108)", "rgb(83,98,99)", "rgb(83,107,89)", "rgb(109,43,61)", "rgb(60,54,80)", "rgb(46,80,46)"]
	var cities = [{blurb: "Emma Green-Geller (Ross and Rachel's", x: 2002.5, y: 0.012},
                    {blurb: "daughter in Friends) is born in 2002", x: 2002.5, y: 0.011},
					{blurb: "Buddy Clark's hit song, ", x: 1942, y: 0.0255},
                    {blurb: "Linda, released in 1942", x: 1942, y: 0.0245},
					{blurb: "Friends, the show with Rachel", x: 1994, y: 0.0095},
                    {blurb: "Green, comes out in 1994", x: 1994, y: 0.0085},
					{blurb: "Love Story (an extremely popular movie", x: 1970, y: 0.0345},
                    {blurb: "with beloved character Jennifer) released in 1970", x: 1970, y: 0.0335},
                    {blurb: "Mariah Carey's hit album", x: 1990.5, y: 0.003},
                    {blurb: "is released in 1990", x: 1990.5, y: 0.002}];
	var textinfo = [[[1990.5, 0.0015], [1990.5, 0.075]], [[1943, 0.0025], [1970, 0.075]], [[1970, 0.035], [1970, 0.075]], [[1942, 0.025], [1942, 0.075]], [[2002, 0.011], [2002, 0.075]]]

	var datesandcounts = {};
	popculturenames.forEach(function(o) {
		datesandcounts[o] = [];
	});
	var legendRectSize = 18;
	var legendSpacing = 4;

var dts;
    function drawOriginalNames(datas) {
        dts=datas;
        var names = new Set();
        datas[1].forEach( function (n) {
            names.add(n.name)
        });
        var counts = [];
        for (var i=2; i < datas.length; i++) {
            var count = 0;
            datas[i].forEach( function (n) {
                if (!names.has(n.name)) {
                    count++;
                    names.add(n.name);
                }
            });
            counts.push(count);
        }
        console.log(counts);

        var scaleX2 = d3.scaleLinear()
                      .domain([1915,2015])
                      .range([65, width2-30]);

        var scaleY2 = d3.scaleLinear()
                      .domain([0,2200])
                      .range([height2-70, 30]);

        var bottom2 = d3.axisBottom(scaleX2)
                      .tickValues(d3.range(1915,2015,5))
                      .tickFormat(d3.format("d"))

        var left2 = d3.axisLeft(scaleY2);

        svg2.append("g")
        .attr("id", "lft2")
        .call(left2)
        .attr("transform", "translate(50, 0)");

        svg2.append("g")
        .attr("id", "btm2")
        .call(bottom2)
        .attr("transform", "translate(0, 430)")
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-9.0")
        .attr("dy", "-4.5")
        .attr("transform", "rotate(-90)");

        for (var i=0; i < counts.length; i++) {
            var x = scaleX2(i+1915)-2;
            var y = scaleY2(counts[i]);

            svg2.append("rect")
                .attr("x", x)
                .attr("y", y)
                .attr("width",5.5)
                .attr("height",(height2-70)-y)
                .style("fill", "rgb(0,102,102)");
        }
    }

    function drawLegend() {
        var circleSizes = [0.0001, 0.0002, 0.0005, 0.0010,  0.002,
                           0.0030, 0.0040,  0.0050];
        var y = 930;


       svg.append("text")
          .attr("dx", scaleX(1933))
          .attr("dy", y)
          .style("text-anchor", "middle")
          .style("alignment-baseline", "middle")
          .style("font-size", "18px")
          .text("Small Circle:");

        svg.append("text")
          .attr("dx", scaleX(1933))
          .attr("dy", y+17)
          .style("text-anchor", "middle")
          .style("alignment-baseline", "middle")
          .style("font-size", "18px")
          .text("Percent Scale:");

        svg.append("rect")
          .attr("x", scaleX(1929))
          .attr("y", y-25)
          .attr("width", scaleX(1991) - scaleX(1928))
          .attr("height", "65")
          .style("stroke", "black")
          .style("fill", "none");


        var legend = svg.append("g")
                        .selectAll("g")
                        .data(circleSizes)
                        .enter()
                            .append("g")
                            .attr("transform", function(d,i){
                                var x = (i * 100)+scaleX(1940);
                                return "translate(" + x + ", " + y + ")";
                            });

        legend.append("circle")
        .style("fill", "rgb(102,0,51)")
        .style("stroke", "black")
        .attr("r", function (d, i) {
            return scaleRad(d);
        });

        legend.append("text")
        .attr("dx", "0")
        .attr("dy", "27")
        .style("text-anchor", "middle")
        .style("alignment-baseline", "middle")
        .style("font-size", "14px")
        .text( function(d, i) {
            return ((d*100).toFixed(2)+"%");
        });
    }
var bibColors;
    function processData(error, datas) {
        bibColors = {};
        for (var i=0; i < bibNames.length; i++) {
            bibColors[bibNames[i]] = colors[i];
        }
        var bibData = [];
        var total = [];
        var yeartotal=0;
        for (var i=0; i<datas.length; i++) {
            var nameSet = new Set(bibNames);
            var year = i + 1913;
            var yearData = { "year": year, "mNames": [], "count": 0 };
            datas[i].forEach(function(n) {

                if (n.gender == "M") {
                    yearData.count = yearData.count + parseInt(n.count);
                }
                if (nameSet.has(n.name) && n.gender=="M") {
                    nameSet.delete(n.name);
                    yearData.mNames.push(n);

                }
                if (n.gender =="F") {
                	yeartotal += parseInt(n.count);
                }
                if (n.gender =="F" && popculturenames.indexOf(n.name) != -1) {

                    datesandcounts[n.name].push(parseInt(n.count));

                }

            });
            total.push(yeartotal);
            yeartotal=0;
            bibData.push(yearData);

            if (year % 5 == 2 || year == 2015) {
                var count = yearData.count;
                var nameCounts = {};
                yearData.mNames.forEach(function (nd) { nameCounts[nd.name] = parseInt(nd.count) });
                var start;
                var startYear;
                if (year == 2015) {
                    start = i-2;
                    startYear = year;
                }
                else {
                    start = i-4;
                    startYear = year-2;
                }
                for (var n = start; n < i; n++) {
                    count = count + bibData[n].count;
                    bibData[n].mNames.forEach(function (p) {
                        nameCounts[p.name] = nameCounts[p.name] + parseInt(p.count);
                    });
                }
                for (var k in nameCounts) {
                    svg.append("circle")
                    .attr("cx", scaleX(startYear))
                    .attr("cy", scaleY(k)+45)
                    .attr("r", scaleRad((nameCounts[k] / count)))
                    .attr("stroke", "black")
                    .attr("fill", bibColors[k]);

                    var percent = (100 * (nameCounts[k] / count)).toFixed(2)
                    if (percent > 0.5) {
                        svg.append("text")
                        .attr("dx", scaleX(startYear))
                        .attr("dy", scaleY(k)+45)
                        .style("text-anchor", "middle")
                        .style("alignment-baseline", "middle")
                        .style("fill", "rgb(53,178,175)")
                        .style("font-size", "13.5px")
                        .text(percent + "%");
                    }
                }
                var line = d3.line()
					.x(function(d,i) {
						return xScale(i+1913);
					})
					.y(function(d, i) {
						return yScale(d/total[i]);
					});
				var textline = d3.line()
					.x(function(d) {
						return xScale(d[0]);
					})
					.y(function(d,i) {
						return yScale(d[1]);
					});

                popculturenames.forEach(function(j) {
                	psvg.append("path")
                	.attr("d", line(datesandcounts[j]))
                	.attr("stroke", namecolors[j])
                    .attr("stroke-width", 2)
                	/*.attr("stroke", function(d, i){
			        	namecolors[i];
			    	})*/
			    	.attr("fill", "none");

                });
                psvg.append('text')
                    .text('Impact of Pop-Culture on Baby Girl Names')
                    .style("text-anchor","middle")
                    .attr('x', 500)
                    .attr('y', 20);

                psvg.append('text')
                    .text('Year')
                    .style("text-anchor","middle")
                    .attr('x', 500)
                    .attr('y', 775);

                psvg.append('text')
                    .attr("transform","rotate(-90)")
                    .attr('x', -350)
                    .attr('y', 25)
                    .style("text-anchor","middle")
                    .text('Percentage of girls named over total births in the year');

                psvg.selectAll("texts")
                	.data(cities)
                	.enter()
                	.append("text")
                	.text(function(d) {  return d.blurb; })
                	.attr("font-size", "12px")
                	.attr('x', function(d) { 
                		return xScale(d.x-10);
                	})
		    		.attr('y', function(d) {
                        if (d.x != 2002.5) {
                		  return yScale(d.y+.0285);
                        } return yScale(d.y+0.03);
                	});

               	psvg.selectAll("paths")
               		.data(cities)
					.enter()
					.append("line")
					.attr("x1", function (d) {
						return xScale(d.x);
					})
					.attr("y1", function (d) {
						return yScale(d.y);
					})
					.attr("x2", function (d) {
						return xScale(d.x);
					})
					.attr("y2", function (d) {
						if (d.x != 2002.5) {
                          return yScale(d.y+.027);
                        } return yScale(d.y+0.0283);
					})
					.style("stroke-width",0.5)
					.style("stroke", "black")
                    .style("opacity", 0.8);


				var legend = psvg.selectAll('.legend')
          		  .data(Object.keys(namecolors))
		          .enter()
		          .append('g')
		          .attr('class', 'legend')
		          .attr('transform', function(d, i) {
		            var wheight = legendRectSize + legendSpacing;
		            var offset =  wheight * Object.keys(namecolors).length / 2;
		            var horz = 50 * legendRectSize;
		            var vert = 100+(i *wheight - offset);
		            return 'translate(' + horz + ',' + vert + ')';
		          });

			    legend.append('rect')
			          .attr('width', legendRectSize)
			          .attr('height', legendRectSize)
			          .style('fill', function (d) {
			          	return namecolors[d];
			          })
			          .style('stroke', function (d) {
			          	return namecolors[d];
			          });

			    legend.append('text')
			          .attr('x', legendRectSize + legendSpacing)
			          .attr('y', legendRectSize - legendSpacing)
			          .text(function (d) {
			          	return d;
			          });
            }
        }
        drawLegend();
        drawOriginalNames(datas);
    };

    var filenames = [];
    for (var i = 1913; i < 2016; i++) {
        filenames.push("data/names/yob" + i + ".csv");
    }

    var queue = d3.queue();
    filenames.forEach(function(filename) {
        queue.defer(d3.csv, filename);
    });
    queue.awaitAll(processData);
    console.log(datesandcounts);


</script>